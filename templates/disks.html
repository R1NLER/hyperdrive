{% extends "base.html" %}
{% set header = "Discos montados" %}
{% set subheader = "Conectado, montado, permanente y Samba" %}

{% block topbar_actions %}
  <!-- Auto-refresh status container -->
  <div id="monitorStatus" class="text-secondary small d-flex align-items-center">
    <span class="spinner-grow spinner-grow-sm text-primary me-2" role="status" style="--bs-spinner-width: 0.5rem; --bs-spinner-height: 0.5rem;"></span>
    Monitoreando
  </div>
  <!-- Hidden refresh button, shown when changes detected -->
  <button id="refreshBtn" class="btn btn-sm btn-primary d-none" onclick="window.location.reload()">
    <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
  </button>
{% endblock %}

{% block content %}
{% set mounted_n = (disks | selectattr('mounted') | list | length) %}
{% set persistent_n = (disks | selectattr('persistent') | list | length) %}
{% set samba_n = (disks | selectattr('samba') | list | length) %}
{% set missing_n = (disks | selectattr('missing') | list | length) %}

<div class="page-head">
  <div class="text-muted">Vista unificada de estado y acciones, sin terminal.</div>
  <div class="chips">
    <div class="chip"><span class="chip-k"><i class="bi bi-hdd-network me-1"></i>Montados</span><span class="chip-v">{{ mounted_n }}</span></div>
    <div class="chip"><span class="chip-k"><i class="bi bi-save me-1"></i>Permanentes</span><span class="chip-v">{{ persistent_n }}</span></div>
    <div class="chip"><span class="chip-k"><i class="bi bi-share me-1"></i>Samba</span><span class="chip-v">{{ samba_n }}</span></div>
    <div class="chip chip-warn"><span class="chip-k"><i class="bi bi-exclamation-triangle me-1"></i>Faltan</span><span class="chip-v">{{ missing_n }}</span></div>
  </div>
</div>

<section class="surface">
  <div class="surface-head">
    <div>
      <div class="surface-title"><i class="bi bi-hdd me-2 text-primary"></i>Discos</div>
      <div class="surface-subtitle">Acciones disponibles dependen del estado actual.</div>
    </div>
  </div>

  <div>
      <!-- Desktop/tablet: tabla -->
      <div class="d-none d-md-block">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Disco</th>
            <th>Tamaño</th>
            <th>FS</th>
            <th>Montaje</th>
            <th>Permanente</th>
            <th>Samba</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for d in disks %}
          <tr class="{{ 'table-warning' if d.missing else '' }}" data-disk-id="{{ d.id }}">
            <td>
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-hdd-fill text-secondary fs-5"></i>
                <div>
                  <div class="fw-semibold">{{ d.label }}</div>
                  <div class="small text-secondary">/dev/{{ d.id }} · UUID {{ d.uuid }}</div>
                </div>
              </div>
            </td>
            <td>{{ d.size }}</td>
            <td><span class="badge bg-dark text-light border border-secondary">{{ d.fstype }}</span></td>
            <td>
              {% if d.mounted %}
                <span class="badge text-bg-success rounded-pill" data-field="mountedBadge"><i class="bi bi-check-circle me-1"></i>Montado</span>
                <div class="small text-secondary mt-1" data-field="mountpoint">{{ d.mountpoint }}</div>
              {% else %}
                <span class="badge text-bg-secondary rounded-pill" data-field="mountedBadge">No montado</span>
                <span class="small text-muted ms-2" data-field="mountpoint"></span>
              {% endif %}
            </td>
            <td>
              {% if d.persistent %}
                <i class="bi bi-check-circle-fill text-primary fs-5" data-field="persistent" title="Sí"></i>
              {% else %}
                <i class="bi bi-circle text-secondary fs-5" data-field="persistent" title="No"></i>
              {% endif %}
            </td>
            <td>
              {% if d.samba %}
                <i class="bi bi-check-circle-fill text-success fs-5" data-field="samba" title="Compartido"></i>
              {% else %}
                <i class="bi bi-circle text-secondary fs-5" data-field="samba" title="No"></i>
              {% endif %}
            </td>
            <td class="text-end" data-field="actions">
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                  {% if d.missing %}
                    <li>
                      <button class="dropdown-item text-danger" type="button" onclick="removeMissingDisk('{{ d.uuid }}', '{{ d.mountpoint }}')">
                        <i class="bi bi-trash me-2"></i>Eliminar
                      </button>
                    </li>
                  {% else %}
                    {% if d.mounted %}
                      <li>
                        <button class="dropdown-item" type="button" onclick="disconnectDisk('{{ d.id }}', '{{ d.mountpoint }}')">
                          <i class="bi bi-eject me-2"></i>Desconectar
                        </button>
                      </li>
                      <li>
                        <button class="dropdown-item text-danger" type="button" onclick="unmountDisk('{{ d.id }}', '{{ d.mountpoint }}')">
                          <i class="bi bi-x-circle me-2"></i>Desmontar
                        </button>
                      </li>
                    {% else %}
                      {% if d.kind == 'disk' %}
                        <li>
                          <button class="dropdown-item" type="button" disabled title="El disco no tiene particiones. Formatea para crear una partición.">
                            <i class="bi bi-slash-circle me-2"></i>Sin partición
                          </button>
                        </li>
                      {% else %}
                        {% if d.persistent %}
                          <li>
                            <button class="dropdown-item" type="button" onclick="reconnectDisk('{{ d.id }}')">
                              <i class="bi bi-plug me-2"></i>Reconectar
                            </button>
                          </li>
                        {% else %}
                          <li>
                            <button class="dropdown-item" type="button" onclick="mountDisk('{{ d.id }}')">
                              <i class="bi bi-play-circle me-2"></i>Montar
                            </button>
                          </li>
                        {% endif %}
                      {% endif %}
                    {% endif %}

                    <li><hr class="dropdown-divider"></li>

                    {# Formateo: solo habilitado si está desmontado, no persistente y no compartido #}
                    {% if (not d.mounted) and (not d.persistent) and (not d.samba) %}
                      <li>
                        <button class="dropdown-item text-danger" type="button" onclick="openFormatModal('{{ d.id }}')">
                          <i class="bi bi-hdd-fill me-2"></i>Formatear
                        </button>
                      </li>
                    {% else %}
                      <li>
                        <button class="dropdown-item text-danger" type="button" disabled title="Requiere: desmontado, no persistente y sin Samba">
                          <i class="bi bi-hdd-fill me-2"></i>Formatear
                        </button>
                      </li>
                    {% endif %}
                  {% endif %}
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <!-- Mobile: cards -->
      <div class="d-md-none">
        <div class="d-grid gap-3">
          {% for d in disks %}
          <div class="card card-soft {{ 'border-warning' if d.missing else '' }}" data-disk-card-id="{{ d.id }}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start gap-2 mb-3">
                <div class="d-flex gap-3 align-items-center min-w-0">
                  <i class="bi bi-hdd-fill fs-1 text-secondary"></i>
                  <div class="min-w-0">
                    <div class="fw-bold text-truncate">{{ d.label }}</div>
                    <div class="small text-secondary text-truncate">/dev/{{ d.id }} · {{ d.size }}</div>
                  </div>
                </div>
                <div data-field="actions">
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow">
                      <!-- Same actions as desktop -->
                      {% if d.missing %}
                        <li><button class="dropdown-item text-danger" onclick="removeMissingDisk('{{ d.uuid }}', '{{ d.mountpoint }}')"><i class="bi bi-trash me-2"></i>Eliminar</button></li>
                      {% else %}
                        {% if d.mounted %}
                          <li><button class="dropdown-item" onclick="disconnectDisk('{{ d.id }}', '{{ d.mountpoint }}')"><i class="bi bi-eject me-2"></i>Desconectar</button></li>
                          <li><button class="dropdown-item text-danger" onclick="unmountDisk('{{ d.id }}', '{{ d.mountpoint }}')"><i class="bi bi-x-circle me-2"></i>Desmontar</button></li>
                        {% else %}
                          {% if d.kind == 'disk' %}
                            <li><button class="dropdown-item" disabled>Sin partición</button></li>
                          {% else %}
                            {% if d.persistent %}
                              <li><button class="dropdown-item" onclick="reconnectDisk('{{ d.id }}')"><i class="bi bi-plug me-2"></i>Reconectar</button></li>
                            {% else %}
                              <li><button class="dropdown-item" onclick="mountDisk('{{ d.id }}')"><i class="bi bi-play-circle me-2"></i>Montar</button></li>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        {% if (not d.mounted) and (not d.persistent) and (not d.samba) %}
                          <li><button class="dropdown-item text-danger" onclick="openFormatModal('{{ d.id }}')"><i class="bi bi-hdd-fill me-2"></i>Formatear</button></li>
                        {% else %}
                          <li><button class="dropdown-item text-danger" disabled><i class="bi bi-hdd-fill me-2"></i>Formatear</button></li>
                        {% endif %}
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-dark border border-secondary">{{ d.fstype }}</span>
                {% if d.mounted %}
                  <span class="badge text-bg-success rounded-pill"><i class="bi bi-check-circle me-1"></i>Montado</span>
                {% else %}
                  <span class="badge text-bg-secondary rounded-pill">No montado</span>
                {% endif %}
                {% if d.persistent %}
                  <span class="badge text-bg-primary rounded-pill"><i class="bi bi-save me-1"></i>Persistente</span>
                {% endif %}
                {% if d.samba %}
                  <span class="badge text-bg-info rounded-pill"><i class="bi bi-share me-1"></i>Samba</span>
                {% endif %}
              </div>
              {% if d.mounted %}
                <div class="mt-2 small text-secondary text-truncate">
                  <i class="bi bi-folder2-open me-1"></i> {{ d.mountpoint }}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
  </div>
</section>

<!-- Modal: Formatear disco -->
<div class="modal fade" id="formatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Formatear disco</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger d-flex align-items-center">
          <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
          <div>
            Esto BORRA TODO el disco completo: se elimina la tabla de particiones y se crea una única partición nueva.
          </div>
        </div>

        <input type="hidden" id="formatDiskId" value="">

        <label class="form-label">Formato</label>
        <select class="form-select bg-dark text-light border-secondary" id="formatFstype">
          <option value="">Cargando…</option>
        </select>

        <label class="form-label mt-3">Etiqueta (opcional)</label>
        <input class="form-control bg-dark text-light border-secondary" id="formatLabel" placeholder="ej: datos" maxlength="32">

        <label class="form-label mt-3">Confirmación</label>
        <div class="small text-muted mb-2">Escribe exactamente: <code id="formatExpected">FORMATEAR</code></div>
        <input class="form-control bg-dark text-light border-secondary" id="formatConfirm" placeholder="FORMATEAR" autocomplete="off" spellcheck="false">
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="formatSubmitBtn" onclick="submitFormatModal()">
          <i class="bi bi-trash me-2"></i>Formatear
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
