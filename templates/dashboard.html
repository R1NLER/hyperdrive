{% extends "base.html" %}
{% set header = "Panel principal" %}
{% set subheader = "Visión general del almacenamiento" %}

{% block content %}
<div class="row g-4">
  <!-- Left Column: Status & Mounted Disks -->
  <div class="col-lg-8">
    
    <!-- System Status Card -->
    <div class="card card-soft mb-4">
      <div class="card-body p-4">
        <div class="d-flex align-items-center gap-3">
          {% if stats.missing > 0 %}
             <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
               <i class="bi bi-exclamation-triangle-fill fs-3"></i>
             </div>
             <div>
               <h4 class="mb-1">Atención requerida</h4>
               <div class="text-secondary">Hay {{ stats.missing }} disco(s) configurado(s) que no se detectan.</div>
             </div>
          {% else %}
             <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
               <i class="bi bi-check-circle-fill fs-3"></i>
             </div>
             <div>
               <h4 class="mb-1">Sistema operativo</h4>
               <div class="text-secondary">Todos los discos configurados están conectados.</div>
             </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Mounted Volumes List -->
    <h5 class="mb-3 px-1">Volúmenes Activos</h5>
    {% set mounted_disks = disks | selectattr('mounted') | list %}
    {% if mounted_disks %}
      <div class="d-grid gap-3">
        {% for d in mounted_disks %}
        <div class="card card-soft">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
              <div class="d-flex align-items-center gap-3 w-100">
                <div class="bg-primary bg-opacity-10 p-2 rounded text-primary flex-shrink-0">
                  <i class="bi bi-hdd-network fs-4"></i>
                </div>
                <div class="min-w-0">
                  <div class="fw-semibold text-truncate">{{ d.label }}</div>
                  <div class="small text-secondary font-monospace text-truncate">{{ d.mountpoint }}</div>
                  <div class="d-flex flex-wrap gap-2 mt-1">
                    <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25" title="Sistema de archivos">
                      {{ d.fstype }}
                    </span>
                    <span class="badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25" title="Tamaño total">
                      {{ d.size }}
                    </span>
                    {% if d.persistent %}
                    <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25" title="Montaje persistente">
                      <i class="bi bi-save"></i> Fstab
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="w-100 w-md-auto mt-2 mt-md-0 ps-md-3" style="min-width: 150px;">
                {% if d.usage %}
                  <div class="d-flex justify-content-between small mb-1">
                    <span class="text-secondary" style="font-size: 0.75rem;">Uso</span>
                    <span class="fw-bold" style="font-size: 0.75rem;">{{ d.usage.percent }}%</span>
                  </div>
                  <div class="progress bg-secondary bg-opacity-25 mb-1" style="height: 4px;">
                    <div class="progress-bar {% if d.usage.percent > 90 %}bg-danger{% elif d.usage.percent > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                         role="progressbar" 
                         style="width: {{ d.usage.percent }}%">
                    </div>
                  </div>
                  <div class="text-secondary text-end" style="font-size: 0.7rem;">
                    <span class="fw-semibold text-light">{{ d.usage.free }}</span> libres de {{ d.usage.total }}
                  </div>
                {% else %}
                  <div class="text-secondary small opacity-50 text-end">
                    <i class="bi bi-hdd fs-4"></i>
                  </div>
                {% endif %}
              </div>
            </div>
            {% if d.samba %}
            <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 text-info small">
                  <i class="bi bi-share-fill"></i> 
                  <span>Compartido en red</span>
                </div>
                <a href="{{ url_for('samba') }}" class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size: 0.75rem;">
                  Gestionar
                </a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card card-soft text-center p-5">
        <div class="text-secondary mb-3">
          <i class="bi bi-hdd fs-1 opacity-50"></i>
        </div>
        <h5>No hay volúmenes montados</h5>
        <p class="text-secondary small">Conecta un disco o monta uno existente desde la sección de Discos.</p>
        <a href="{{ url_for('disks') }}" class="btn btn-primary btn-sm mt-2">Ir a Discos</a>
      </div>
    {% endif %}

  </div>

  <!-- Right Column: Mini Stats & Alerts -->
  <div class="col-lg-4">
    
    <!-- Mini Stats List -->
    <div class="card card-soft mb-4">
      <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 py-3">
        <h6 class="m-0">Estadísticas</h6>
      </div>
      <ul class="list-group list-group-flush">
        <li class="list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between align-items-center text-light">
          <span class="text-secondary"><i class="bi bi-hdd me-2"></i>Detectados</span>
          <span class="fw-bold">{{ stats.detected }}</span>
        </li>
        <li class="list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between align-items-center text-light">
          <span class="text-secondary"><i class="bi bi-save me-2"></i>Persistentes</span>
          <span class="fw-bold">{{ stats.persistent }}</span>
        </li>
        <li class="list-group-item bg-transparent border-secondary border-opacity-25 d-flex justify-content-between align-items-center text-light">
          <span class="text-secondary"><i class="bi bi-share me-2"></i>Samba</span>
          <span class="fw-bold">{{ stats.samba }}</span>
        </li>
      </ul>
    </div>

    <!-- Missing Disks Alerts (if any) -->
    {% if stats.missing > 0 %}
    <div class="card border-warning bg-warning bg-opacity-10">
      <div class="card-header bg-transparent border-warning border-opacity-25 text-warning fw-bold">
        <i class="bi bi-exclamation-triangle me-2"></i>Discos Faltantes
      </div>
      <div class="list-group list-group-flush">
        {% for d in disks %}
          {% if d.missing %}
            <div class="list-group-item bg-transparent border-warning border-opacity-25 text-light">
              <div class="fw-semibold">{{ d.label }}</div>
              <div class="small opacity-75">UUID: {{ d.uuid }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <div class="card-body pt-0">
        <a href="{{ url_for('disks') }}" class="btn btn-warning btn-sm w-100 mt-3">Gestionar</a>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}
